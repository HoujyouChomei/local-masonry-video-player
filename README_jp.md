[ [English](README.md) | 日本語 ]

![CI](https://github.com/HoujyouChomei/local-masonry-video-player/actions/workflows/ci.yml/badge.svg)

# Local Masonry Video Player

![Electron](https://img.shields.io/badge/Electron-191970?style=for-the-badge&logo=Electron&logoColor=white) ![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white) ![React](https://img.shields.io/badge/React-20232A?style=for-the-badge&logo=react&logoColor=61DAFB) ![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)

**動画素材や動画生成AI用ローカルビデオプレイヤー。**

https://github.com/user-attachments/assets/a5b6266b-440a-41cd-8256-88c5ad88e9a2

## 主な機能

*   **Masonry Gridレイアウト**: 動画のアスペクト比を維持し、隙間なくタイル状に配置します。
*   **フォルダ参照型管理**: ファイルの実体を移動せず、インデックスのみを作成して管理します。
*   **ファイル監視**: 対象フォルダ内のファイル追加・削除・変更を検知し、ライブラリを自動更新します。
*   **ファイル操作**: アプリ内からローカルファイルのリネーム、フォルダ移動、削除（ゴミ箱へ移動）が可能です。
*   **ドラッグ＆ドロップ**: アプリ外（ComfyUI等の外部ツール）へのファイルドロップや、アプリ内でのフォルダ移動に対応しています。
*   **モバイル連携**: **(実験機能)** 同一ネットワーク内のスマートフォンからQRコードで接続し、PC内の動画をストリーミング再生できます。
*   **整理機能**: プレイリスト作成、タグ付け、お気に入り登録機能があります。
*   **メタデータ収集**: **(要FFmpeg - 設定からワンクリックで導入可)** AI生成動画のプロンプト情報（JSON）、FPS、Codec等の技術情報を自動取得して表示・検索に使用できます。

### [⬇️ Download Latest Version](https://github.com/HoujyouChomei/local-masonry-video-player/releases) | [🌐 インストール不要デモ](https://local-masonry-video-player-demo.pages.dev) | [ソースからのビルド](#ソースからのビルド)

> **デモについて**: WebデモはUI確認用です。パフォーマンスのため自動再生は無効化しています。

> **Note**:
> 本アプリケーションはWindowsでのみ動作確認をしています。
> また、個人のオープンソースプロジェクトであり有償認証を購入していないため、初回起動時にSmartScreenの警告が表示されます。
> 自己責任での利用をお願いします。不安な方はソースをご確認ください。

## 検索機能

*   **スコープ切り替え**: 現在のフォルダ内のみを検索するか、登録済みライブラリ全体（グローバル）を検索するかを切り替え可能です。
*   **高度な検索**:
    *   **FFmpegなし**: ファイル名のみ検索対象。
    *   **FFmpegあり**: ファイル名に加え、AIプロンプト、FPS、Codecなどのメタデータも検索対象になります。
    *   **特殊構文**: `fps:60` や `codec:h264` と入力することで、技術的な仕様でフィルタリングが可能です。

## モバイル連携 [実験機能]

設定で本機能をONにした時のみ、PCで起動中のアプリが「サーバー」として動作し、スマートフォンからアクセスできます。

**⚠️ 注意**: 
本機能は実験機能であり、快適な動作を保証するものではありません。
現在は **Android** でのみ動作確認を行っています。
安全のため、公共の無線LAN（フリーWi-Fi）では使用しないでください。

### 接続手順
1.  PC側でアプリの `設定 (Settings) > EXPERIMENTAL` セクションを開きます。
2.  `Mobile Connect` のトグルスイッチをONにします。
> **※ 通信許可の確認**
> モバイル連携をONにすると、スマートフォンと通信するためのサーバー機能が起動します。
> その際、Windowsから「このアプリの機能のいくつかがファイアウォールでブロックされています」という確認画面が表示される場合があります。
> 
> スマホからのアクセスをしたい方は、**「アクセスを許可する」** を選択してください。
3.  表示されたQRコードをスマートフォンで読み取ります。
4.  ブラウザが立ち上がり、PC内のライブラリにアクセスできます。

> **セキュリティについて**:
> QRコードには、接続に必要な **認証トークン** が含まれています。これにより、QRコードを読み取った本人だけが安全にアクセスできます。

> **再接続について**:
> 一度接続に成功した場合、URL（トークンを含む）をブックマークや履歴から開くことで、次回以降はQRコードを読み取らなくても接続可能です（PC側のMobile ConnectがONになっている必要があります）。

### 接続できない場合
スマートフォンから接続できない場合は、以下の設定を確認してください。

1.  **同一LAN接続**: PCとスマートフォンが同じWi-Fi（ルーター）に接続されている必要があります。
2.  **ファイアウォール設定**: Windows Defender ファイアウォール等が通信をブロックしている可能性があります。
    *   「ファイアウォールとネットワーク保護」設定を開きます。
    *   「ファイアウォールによるアプリケーションの許可」を選択します。
    *   一覧から `electron.exe` (または本アプリ名) を探し、**プライベート**（および必要ならパブリック）にチェックを入れて許可してください。

## 再生仕様とFFmpegについて

本アプリはライセンス回避のため、**FFmpegを含めずに配布しています。**
そのため、初期状態では機能に制限があります。すべての機能を利用するには、設定からワンクリックで導入するか、ユーザー自身でffmpegのパスを設定する必要があります。

### 再生モードの仕様

| 機能 | FFmpeg なし | FFmpeg あり |
| :--- | :--- | :--- |
| **詳細プレーヤー**<br>(クリックして開く) | MP4, WebM のみ再生可能 | **多くの動画形式を再生可能**<br>(MKV, AVI, WMV 等) |
| **一覧画面での同時再生**<br>(グリッド表示) | MP4, WebM のみ | **変化なし**<br>(Chromium準拠のため、FFmpegを入れてもMP4/WebMのみ) |
| **データ取得** | 基本情報のみ | **FPS/Codec、AIプロンプト取得が可能** |

### FFmpeg 導入手順

#### 方法1: ワンクリックインストール (推奨)
Windows および macOS の場合、設定画面からワンクリックで導入できます。
下記のマニュアルインストールと同じことを自動でします。

1.  アプリの `設定 (Settings) > External Tools` セクションを開きます。
2.  `Auto Install` ボタンをクリックします。
3.  ダウンロードと設定が自動的に行われます。

#### 方法2: 手動インストール(セキュリティが不安な方向け)
1.  OSに対応した FFmpeg を導入してください。
    *   **Windows**: [Gyan.dev](https://www.gyan.dev/ffmpeg/builds/) からダウンロード。
    *   **macOS**: [Evermeet.cx](https://evermeet.cx/ffmpeg/) からダウンロード。
    *   **Linux**: パッケージマネージャーを使用してください（例: `sudo apt install ffmpeg`）。
2.  **Windows/macOSの場合**: 解凍したフォルダ内にある `ffmpeg` (Windowsなら `ffmpeg.exe`) と `ffprobe` (Windowsなら `ffprobe.exe`) を任意の場所に保存します。
3.  アプリの設定画面 (Settings) > External Tools セクションを開き、それぞれのパスを指定してください。（Linuxの場合は通常 `/usr/bin/ffmpeg` 等にあります）

## データ収集と検索インデックスの仕様

本アプリはバックグラウンドで動画のメタデータを収集しますが、**以下の条件を満たす必要があります。**

1.  **FFmpegの設定**: 設定画面で `ffmpeg` および `ffprobe` のパスが正しく指定されていること。
2.  **フォルダの読み込み**: 対象の動画が含まれるフォルダを、**一度アプリ内で開く（表示する）必要があります。**
    *   フォルダを開くとバックグラウンドで軽量スキャンが走り、検索インデックスに登録されます。
    *   詳細情報（AIプロンプトやFPSなど）が表示されるまで、数秒〜数分のラグが発生する場合があります。

## ショートカットキー & 操作

### 共通 / 一覧画面 (Grid View)
| キー | 動作 |
| :--- | :--- |
| `Ctrl` + `B` | サイドバーの開閉 |
| `Ctrl` + `Click` | 複数選択モード開始 |
| `Shift` + `Click` | 範囲選択 |
| `Esc` | 選択解除 / メニューを閉じる |

### 詳細プレーヤー (Modal Player)
| キー | 動作 |
| :--- | :--- |
| `Space` | 再生 / 一時停止 |
| `F` | フルスクリーン切り替え |
| `I` | **情報パネル (メタデータ・プロンプト) の開閉** |
| `←` / `→` | 前の動画 / 次の動画へ移動 |
| `Mouse Wheel` | 前の動画 / 次の動画へ移動 |
| `Esc` | プレーヤーを閉じる |

### モバイル操作 (Touch)
| アクション | 動作 |
| :--- | :--- |
| **スワイプ (左右)** | 前の動画 / 次の動画へ移動 |
| **タップ** | コントロールの表示/非表示 |

## 注意事項

### 大容量の動画ファイルについて
アプリケーションの安定性のため、初期設定では大容量の動画ファイルの自動再生が制限されています。
デフォルトでは **100MB** を超える動画は、サムネイルにマウスカーソルを合わせた時のみプレビュー再生が開始されます。

この制限は `設定 (Settings) > Performance` セクションから、閾値の変更または機能の無効化が可能です。

### 特定の動画で再生が停止する問題について
動画の解像度が奇数（例: `1023x767`）など、エンコードが標準的でない一部の動画は、GPUのハードウェアアクセラレーションとの相性問題で再生が停止（スタック）することがあります。
この問題が発生した場合、以下のいずれかの方法で解決できる可能性があります。

1.  **ハードウェアアクセラレーションを無効にする**
    `設定 (Settings) > System` を開き、`Hardware Accel` のトグルをOFFにしてください。設定の適用には**アプリケーションの再起動が必要です。**

2.  **動画を再エンコードする (要FFmpeg)**
    この機能を利用するには、以下の手順が必要です。
    1.  FFmpegを導入してください。
    2.  FFmpegが正しく認識されると、設定パネル内に `Experimental Features` という項目が表示されます。
    3.  その中にある `Enable "Normalize Video"` の項目を有効にしてください。
    
    上記の手順を完了すると、動画の右クリックメニューに `Normalize Video` が表示されるようになります。これを実行すると、互換性の高い偶数解像度のMP4ファイルが新しく生成されます。

## 技術概要
### 技術スタック
*   **Core**: Electron, Vite, React, TypeScript
*   **Frontend UI**: Tailwind CSS, Shadcn UI, Lucide React
*   **State Management**: Zustand, TanStack Query
*   **Database**: better-sqlite3 (SQLite)
*   **Server**: Node.js HTTP Server + SSE (Server-Sent Events)
*   **Communication**: tRPC (Abstracts IPC/HTTP for unified codebase)

### アーキテクチャ
*   **Frontend**: Feature-Sliced Design (FSD) ベース。
*   **Backend**: Repositoryパターンを用いたレイヤードアーキテクチャを基盤とし、内部Event Busによるイベント駆動アーキテクチャ(EDA)を採用。

### データ管理と検索
*   **SQLite**: メタデータ、設定、プレイリスト情報を単一の `.db` ファイルで管理。
*   **検索機能**: SQLiteの全文検索モジュール (**FTS5**) 。
*   **ポータブルデータ構造**: アプリケーション設定やデータベース（`userData`）は実行ファイルと同階層に保存。

### ファイル整合性と自動復元
*   **監視システム**: `chokidar` をWorkerスレッドで実行し、ファイルシステムの変更を検知。
*   **欠損処理**: ファイルが移動または削除された際、即座にレコードを削除せず `missing` ステータスとして保持。
*   **自動復元**:
    *   **Inode追跡**: 同一ボリューム内での移動は、ファイルシステムのInode番号を照合してパスを更新。
    *   **ハッシュ照合**: 別ボリュームへの移動やInode変更時は、ファイルサイズと部分ハッシュを用いて同一性を検証し、メタデータを復元。

## ロードマップ

*実装を保証するものではありません*

*   画像ファイルのサポート
*   ヘッドレスサーバーモード

## アンインストール方法

本アプリはポータブル形式で動作します。レジストリを使用せず、設定ファイルやデータベースも実行ファイルと同じフォルダ内の `userData` フォルダに保存されます。

*   **削除手順**: ダウンロード・解凍したフォルダをそのままゴミ箱に捨ててください。これだけですべてのデータが削除されます。

## ソースからのビルド

*   Node.js (v22.x 推奨 / v22.17.0 動作確認済み)

1.  **リポジトリのクローンと移動**
    ```bash
    git clone https://github.com/HoujyouChomei/local-masonry-video-player.git
    cd local-masonry-video-player
    ```

2.  **依存関係のインストール**
    ```bash
    npm install
    ```

3.  **Electron用ネイティブモジュールの再ビルド**
    Required to generate necessary assets.
    ```bash
    npm run rebuild
    ```

4.  **開発モードで起動**
    ```bash
    npm run dev
    ```

5.  **配布用にビルド**
    (成果物は `release` フォルダに出力されます)
    ```bash
    npm run dist
    ```


## ライセンス

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
